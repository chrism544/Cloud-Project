// Prisma schema for Portal Management System
// PostgreSQL provider with multi-tenant row-level isolation via portalId fields

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Portal {
  id               String        @id @default(uuid()) @db.Uuid
  name             String        @db.VarChar(255)
  subdomain        String        @unique @db.VarChar(100)
  customDomain     String?       @unique @db.VarChar(255)
  assetContainerId String?       @db.Uuid
  isActive         Boolean       @default(true)
  createdAt        DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime      @default(now()) @updatedAt @db.Timestamptz(6)

  assetContainer   AssetContainer?  @relation(fields: [assetContainerId], references: [id], onDelete: SetNull)
  users            User[]
  pages            Page[]
  menus            Menu[]
  storageFiles     StorageFile[]
  auditLogs        AuditLog[]
  // Admin extensions relations
  userOnPortals    UserOnPortal[]  @relation("UserOnPortalPortal")
  themes           Theme[]         @relation("ThemePortal")
  globalContents   GlobalContent[] @relation("GlobalContentPortal")
  pageAnalytics    PageAnalytics[] @relation("PageAnalyticsPortal")
  userActivities   UserActivity[]  @relation("UserActivityPortal")
  securityAlerts   SecurityAlert[] @relation("SecurityAlertPortal")

  @@index([subdomain])
  @@index([customDomain])
  @@index([isActive])
}

model User {
  id            String         @id @default(uuid()) @db.Uuid
  email         String         @unique @db.VarChar(255)
  passwordHash  String         @db.VarChar(255)
  firstName     String?        @db.VarChar(100)
  lastName      String?        @db.VarChar(100)
  portalId      String         @db.Uuid
  role          String         @default("viewer") @db.VarChar(50)
  isActive      Boolean        @default(true)
  emailVerified Boolean        @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime       @default(now()) @updatedAt @db.Timestamptz(6)

  portal               Portal            @relation(fields: [portalId], references: [id], onDelete: Cascade)
  refreshTokens        RefreshToken[]
  passwordResetTokens  PasswordResetToken[]
  pagesCreated         Page[]            @relation("PageCreator")
  pagesUpdated         Page[]            @relation("PageUpdater")
  storageFiles         StorageFile[]     @relation("FileUploader")
  auditLogs            AuditLog[]
  // Admin extensions relations
  userOnPortals        UserOnPortal[]    @relation("UserOnPortalUser")
  activities           UserActivity[]    @relation("UserActivityUser")
  resolvedSecurityAlerts SecurityAlert[] @relation("SecurityAlertResolver")
  updatedSystemConfigs SystemConfig[]    @relation("SystemConfigUpdater")

  @@index([email])
  @@index([portalId])
  @@index([role])
}

model RefreshToken {
  id         String   @id @default(uuid()) @db.Uuid
  tokenHash  String   @unique @db.VarChar(255)
  userId     String   @db.Uuid
  deviceInfo String?  @db.Text
  ipAddress  String?  @db.VarChar(45)
  expiresAt  DateTime @db.Timestamptz(6)
  isRevoked  Boolean  @default(false)
  revokedAt  DateTime?
  createdAt  DateTime @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([tokenHash])
}

model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  tokenHash String   @unique @db.VarChar(255)
  expiresAt DateTime @db.Timestamptz(6)
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model AssetContainer {
  id                 String           @id @default(uuid()) @db.Uuid
  name               String           @db.VarChar(255)
  description        String?
  parentId           String?          @db.Uuid
  logoUrl            String?          @db.VarChar(1024)
  faviconUrl         String?          @db.VarChar(1024)
  primaryFontUrl     String?          @db.VarChar(1024)
  backgroundImageUrl String?          @db.VarChar(1024)
  cssOverrides       String?
  colorPrimary       String?          @db.VarChar(20)
  colorSecondary     String?          @db.VarChar(20)
  colorAccent        String?          @db.VarChar(20)
  colorBackground    String?          @db.VarChar(20)
  colorText          String?          @db.VarChar(20)
  createdAt          DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime         @default(now()) @updatedAt @db.Timestamptz(6)

  parent   AssetContainer?  @relation("AssetContainerHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children AssetContainer[] @relation("AssetContainerHierarchy")
  portals  Portal[]

  @@index([name])
  @@index([parentId])
}

model Page {
  id              String    @id @default(uuid()) @db.Uuid
  portalId        String    @db.Uuid
  title           String    @db.VarChar(500)
  slug            String    @db.VarChar(200)
  content         Json
  metaDescription String?
  metaKeywords    String?
  isPublished     Boolean   @default(false)
  publishedAt     DateTime?
  ogImageUrl      String?   @db.VarChar(1024)
  version         Int       @default(1)
  parentVersionId String?   @db.Uuid
  createdBy       String?   @db.Uuid
  updatedBy       String?   @db.Uuid
  // SEO fields
  seoTitle        String?   @db.VarChar(500)
  canonicalUrl    String?   @db.VarChar(1024)
  noIndex         Boolean   @default(false)
  noFollow        Boolean   @default(false)
  structuredData  Json?
  // Custom CSS/JS
  customCss       String?   @db.Text
  customJs        String?   @db.Text
  // i18n
  locale          String?   @db.VarChar(10)
  translationOf   String?   @db.Uuid
  createdAt       DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  portal        Portal           @relation(fields: [portalId], references: [id], onDelete: Cascade)
  creator       User?            @relation("PageCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  updater       User?            @relation("PageUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
  parentVersion Page?            @relation("PageVersions", fields: [parentVersionId], references: [id], onDelete: SetNull)
  childVersions Page[]           @relation("PageVersions")
  // Admin extensions relations
  analytics     PageAnalytics[]  @relation("PageAnalyticsPage")

  @@unique([portalId, slug])
  @@index([portalId])
  @@index([slug])
  @@index([isPublished])
  @@index([createdBy])
  @@index([locale])
}

model Menu {
  id        String    @id @default(uuid()) @db.Uuid
  portalId  String    @db.Uuid
  name      String    @db.VarChar(255)
  location  String    @db.VarChar(100)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  portal Portal     @relation(fields: [portalId], references: [id], onDelete: Cascade)
  items  MenuItem[]

  @@unique([portalId, location])
  @@index([portalId])
  @@index([location])
}

model MenuItem {
  id           String    @id @default(uuid()) @db.Uuid
  menuId       String    @db.Uuid
  parentId     String?   @db.Uuid
  title        String    @db.VarChar(255)
  linkUrl      String?   @db.VarChar(1024)
  icon         String?   @db.VarChar(100)
  displayOrder Int       @default(0)
  isVisible    Boolean   @default(true)
  openInNewTab Boolean   @default(false)
  requiredRole String?   @db.VarChar(50)
  createdAt    DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  menu     Menu       @relation(fields: [menuId], references: [id], onDelete: Cascade)
  parent   MenuItem?  @relation("MenuItemHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children MenuItem[] @relation("MenuItemHierarchy")

  @@index([menuId])
  @@index([parentId])
  @@index([displayOrder])
}

model AuditLog {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String?   @db.Uuid
  portalId     String?   @db.Uuid
  action       String    @db.VarChar(100)
  resourceType String    @db.VarChar(100)
  resourceId   String?   @db.Uuid
  changes      Json?
  ipAddress    String?   @db.VarChar(45)
  userAgent    String?
  createdAt    DateTime  @default(now()) @db.Timestamptz(6)

  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  portal Portal? @relation(fields: [portalId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([portalId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([createdAt])
}

model StorageFile {
  id               String    @id @default(uuid()) @db.Uuid
  portalId         String    @db.Uuid
  originalFilename String    @db.VarChar(500)
  storedFilename   String    @db.VarChar(500)
  mimeType         String    @db.VarChar(100)
  fileSize         BigInt
  storageProvider  String    @db.VarChar(50)
  storageBucket    String?   @db.VarChar(255)
  storagePath      String    @db.VarChar(1024)
  storageUrl       String    @db.VarChar(1024)
  uploadedBy       String?   @db.Uuid
  isDeleted        Boolean   @default(false)
  deletedAt        DateTime?
  createdAt        DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  portal   Portal @relation(fields: [portalId], references: [id], onDelete: Cascade)
  uploader User?  @relation("FileUploader", fields: [uploadedBy], references: [id], onDelete: SetNull)

  @@index([portalId])
  @@index([storageProvider])
  @@index([uploadedBy])
  @@index([isDeleted])
}

// --- Admin Portal Extensions ---

enum UserRole {
  SUPER_ADMIN
  PORTAL_ADMIN
  EDITOR
  VIEWER
}

model UserOnPortal {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @db.Uuid
  portalId     String    @db.Uuid
  assignedRole UserRole  @default(VIEWER)
  permissions  Json?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @db.Timestamptz(6)

  user   User   @relation("UserOnPortalUser", fields: [userId], references: [id], onDelete: Cascade)
  portal Portal @relation("UserOnPortalPortal", fields: [portalId], references: [id], onDelete: Cascade)

  @@unique([userId, portalId])
  @@index([userId])
  @@index([portalId])
}

model Theme {
  id        String    @id @default(uuid()) @db.Uuid
  name      String    @db.VarChar(255)
  portalId  String    @db.Uuid
  isActive  Boolean   @default(false)
  tokens    Json
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @db.Timestamptz(6)

  portal    Portal    @relation("ThemePortal", fields: [portalId], references: [id], onDelete: Cascade)

  @@unique([portalId, isActive])
  @@index([portalId])
}

model GlobalContent {
  id        String    @id @default(uuid()) @db.Uuid
  name      String    @db.VarChar(255)
  key       String    @db.VarChar(100)
  content   Json
  portalId  String    @db.Uuid
  category  String?   @db.VarChar(100)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @db.Timestamptz(6)

  portal    Portal    @relation("GlobalContentPortal", fields: [portalId], references: [id], onDelete: Cascade)

  @@unique([portalId, key])
  @@index([portalId])
  @@index([category])
}

model PageAnalytics {
  id            String    @id @default(uuid()) @db.Uuid
  pageId        String    @db.Uuid
  portalId      String    @db.Uuid
  views         Int       @default(0)
  uniqueViews   Int       @default(0)
  avgTimeOnPage Float?
  bounceRate    Float?
  date          DateTime  @default(now()) @db.Timestamptz(6)

  page   Page   @relation("PageAnalyticsPage", fields: [pageId], references: [id], onDelete: Cascade)
  portal Portal @relation("PageAnalyticsPortal", fields: [portalId], references: [id], onDelete: Cascade)

  @@unique([pageId, date])
  @@index([portalId])
  @@index([date])
}

model UserActivity {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @db.Uuid
  portalId     String    @db.Uuid
  action       String    @db.VarChar(100)
  resourceType String    @db.VarChar(100)
  resourceId   String?   @db.Uuid
  metadata     Json?
  timestamp    DateTime  @default(now()) @db.Timestamptz(6)

  user   User   @relation("UserActivityUser", fields: [userId], references: [id], onDelete: Cascade)
  portal Portal @relation("UserActivityPortal", fields: [portalId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([portalId])
  @@index([action])
  @@index([timestamp])
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model SecurityAlert {
  id          String        @id @default(uuid()) @db.Uuid
  portalId    String        @db.Uuid
  type        String        @db.VarChar(100)
  severity    AlertSeverity
  description String        @db.Text
  metadata    Json?
  resolved    Boolean       @default(false)
  resolvedBy  String?       @db.Uuid
  resolvedAt  DateTime?
  createdAt   DateTime      @default(now()) @db.Timestamptz(6)

  portal   Portal @relation("SecurityAlertPortal", fields: [portalId], references: [id], onDelete: Cascade)
  resolver User?  @relation("SecurityAlertResolver", fields: [resolvedBy], references: [id], onDelete: SetNull)

  @@index([portalId])
  @@index([severity])
  @@index([resolved])
}

model SystemConfig {
  id        String    @id @default(uuid()) @db.Uuid
  key       String    @unique @db.VarChar(100)
  value     Json
  category  String    @db.VarChar(50)
  updatedBy String?   @db.Uuid
  updatedAt DateTime  @updatedAt @db.Timestamptz(6)

  updater   User?     @relation("SystemConfigUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)

  @@index([category])
}

model GlobalSettings {
  id                String    @id @default(uuid()) @db.Uuid
  portalId          String    @unique @db.Uuid
  siteName          String?   @db.VarChar(255)
  siteDescription   String?   @db.Text
  faviconUrl        String?   @db.VarChar(1024)
  logoUrl           String?   @db.VarChar(1024)
  defaultLocale     String    @default("en") @db.VarChar(10)
  timezone          String    @default("UTC") @db.VarChar(50)
  analyticsCode     String?   @db.Text
  googleTagManager  String?   @db.VarChar(50)
  customHeadCode    String?   @db.Text
  customFooterCode  String?   @db.Text
  maintenanceMode   Boolean   @default(false)
  maintenanceMessage String?  @db.Text
  socialLinks       Json?
  contactInfo       Json?
  createdAt         DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @db.Timestamptz(6)

  @@index([portalId])
}
